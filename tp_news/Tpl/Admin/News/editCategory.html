<style type="text/css">
.ztree li span.button.add {margin-left:2px; margin-right: -1px; background-position:-144px 0; vertical-align:top; *vertical-align:middle}
.ztree li span.button  {float: none;}
</style>
<div class="pageContent">
	<form id="cateoryForm" method="post" action="__APP__/Admin/News/updateCateory" class="pageForm required-validate" onsubmit="return validateCallback(this, dialogAjaxDone);">
        </form>
	<div class="pageFormContent" layoutH="58">
                <ul id="ztreeCategory" class="ztree"></ul>
	</div>
	<div class="formBar">
		<ul>
                    <li><div class="buttonActive"><div class="buttonContent"><button type="button" onclick="subEditCategory();">保存</button></div></div></li>
			<li><div class="button"><div class="buttonContent"><button class="close" type="button">关闭</button></div></div></li>
		</ul>
	</div>
</div>
<script type="text/javascript">
var setting = {
    view: {
            addHoverDom: addHoverDom,
            removeHoverDom: removeHoverDom,
            selectedMulti: false
    },
    edit: {
            enable: true,
            editNameSelectAll: true,
            showRemoveBtn: true,
            showRenameBtn: true
    },
    check: {
            enable: true
    },
    data: {
            simpleData: {
                    enable: true
            }
    },
    callback: {
            beforeDrag: beforeDrag,
            //beforeEditName: beforeEditName,
            beforeRemove: beforeRemove,
            beforeRename: beforeRename,
            onRemove: onRemove,
            onRename: onRename
    }
};
var zNodes = [];
<volist name="data" id="dataNodes" mod="5">
zNodes.push({
    id:"{$dataNodes.id}",
    pId:"{$dataNodes.pid}", 
    name:"{$dataNodes.name}", 
    checked:<if condition="($dataNodes.status eq 1)">true<else />false</if>,
    open:<if condition="($dataNodes.open eq 1)">true<else />false</if>
});
</volist>
//var zNodes =[
//    { id:1, pId:0, name:"父分类", open:true},
//    { id:11, pId:1, name:"公司动态"},
//    { id:12, pId:1, name:"相关新闻"},
//    { id:13, pId:1, name:"法律规范"}
//];
var log, className = "dark";
function beforeDrag(treeId, treeNodes) {
        return false;
}
function beforeEditName(treeId, treeNode) {
        className = (className === "dark" ? "":"dark");
        showLog("[ "+getTime()+" beforeEditName ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name);
        var zTree = $.fn.zTree.getZTreeObj("ztreeCategory");
        zTree.selectNode(treeNode);
        return confirm("进入节点 -- " + treeNode.name + " 的编辑状态吗？");
}
function beforeRemove(treeId, treeNode) {
        className = (className === "dark" ? "":"dark");
        showLog("[ "+getTime()+" beforeRemove ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name);
        var zTree = $.fn.zTree.getZTreeObj("ztreeCategory");
        zTree.selectNode(treeNode);
        return confirm("确认删除分类【" + treeNode.name + "】 吗？");
}
function onRemove(e, treeId, treeNode) {
        showLog("[ "+getTime()+" onRemove ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name);
}
function beforeRename(treeId, treeNode, newName, isCancel) {
        className = (className === "dark" ? "":"dark");
        showLog((isCancel ? "<span style='color:red'>":"") + "[ "+getTime()+" beforeRename ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name + (isCancel ? "</span>":""));
        if (newName.length == 0) {
                alert("节点名称不能为空.");
                var zTree = $.fn.zTree.getZTreeObj("ztreeCategory");
                setTimeout(function(){zTree.editName(treeNode)}, 10);
                return false;
        }
        return true;
}
function onRename(e, treeId, treeNode, isCancel) {
        showLog((isCancel ? "<span style='color:red'>":"") + "[ "+getTime()+" onRename ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name + (isCancel ? "</span>":""));
}
function showRemoveBtn(treeId, treeNode) {
        return !treeNode.isFirstNode;
}
function showRenameBtn(treeId, treeNode) {
        return !treeNode.isLastNode;
}
function showLog(str) {
        if (!log) log = $("#log");
        log.append("<li class='"+className+"'>"+str+"</li>");
        if(log.children("li").length > 8) {
                log.get(0).removeChild(log.children("li")[0]);
        }
}
function getTime() {
        var now= new Date(),
        h=now.getHours(),
        m=now.getMinutes(),
        s=now.getSeconds(),
        ms=now.getMilliseconds();
        return (h+":"+m+":"+s+ " " +ms);
}

var newCount = 1;
function addHoverDom(treeId, treeNode) {
        var sObj = $("#" + treeNode.tId + "_span");
        if (treeNode.editNameFlag || $("#addBtn_"+treeNode.tId).length>0) return;
        var addStr = "<span class='button add' id='addBtn_" + treeNode.tId
                + "' title='add node' onfocus='this.blur();'></span>";
        sObj.after(addStr);
        var btn = $("#addBtn_"+treeNode.tId);
        if (btn) btn.bind("click", function(){
                var zTree = $.fn.zTree.getZTreeObj("ztreeCategory");
                zTree.addNodes(treeNode, {id:(100 + newCount), pId:treeNode.id, name:"新分类" + (newCount++)});
                return false;
        });
};
function removeHoverDom(treeId, treeNode) {
        $("#addBtn_"+treeNode.tId).unbind().remove();
};
function selectAll() {
        var zTree = $.fn.zTree.getZTreeObj("ztreeCategory");
        zTree.setting.edit.editNameSelectAll =  $("#selectAll").attr("checked");
}

function subEditCategory(){
    var treeObj = $.fn.zTree.getZTreeObj("ztreeCategory");
    var nodes = treeObj.transformToArray(treeObj.getNodes());
    var form = $('<form></form>');
    form.attr('action', '__APP__/Admin/News/updateCateory');
    form.attr('method', 'post');
    $.each(nodes,function(idx){
        var pid = nodes[idx].pId == null ? 0 : nodes[idx].pId;
        var checked = nodes[idx].checked ? 1 : 0;
        var open = nodes[idx].open ? 1 : 0;
        var data_val = nodes[idx].id+"_"+pid+"_"+checked+"_"+open+"_"+nodes[idx].name;
        var my_input = $('<input type="text" name="line_data[]" value="'+data_val+'" />');
        form.append(my_input);
    })
    $(form).ajaxSubmit(function(returnData) {
    });
    return false;
}

$(document).ready(function(){
        $.fn.zTree.init($("#ztreeCategory"), setting, zNodes);
});
</script>